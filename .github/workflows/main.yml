name: Offline App V6 (Clean Room)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Tools
        uses: actions/setup-node@v4
        with: {node-version: 20}
      - uses: actions/setup-java@v4
        with: {java-version: '17', distribution: 'temurin'}

      - name: ğŸ—ï¸ Prepare Clean Build Area
        run: |
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø¹Ù…Ù„ Ù…Ø¹Ø²ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
          mkdir /tmp/app_build
          cd /tmp/app_build
          
          # 2. ØªØ¬Ù‡ÙŠØ² Ø£Ø¯ÙˆØ§Øª ÙƒØ§Ø¨Ø³ØªÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android

          # 3. Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          mkdir www
          
      - name: ğŸ“‚ Copy Your Files
        run: |
          # Ù†Ø³Ø® Ù…Ù„ÙØ§ØªÙƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø²ÙˆÙ„
          # Ù†Ø³ØªØ«Ù†ÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ÙƒÙŠ Ù„Ø§ Ù†Ù†Ø³Ø® Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
          rsync -av --exclude='.git' --exclude='.github' ./ /tmp/app_build/www/
          
          echo "âœ… Files copied to clean area:"
          ls -R /tmp/app_build/www/

      - name: ğŸš€ Build APK
        run: |
          cd /tmp/app_build
          
          # ØªØ¹Ø±ÙŠÙ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØ£ÙƒØ¯Ù†Ø§ Ù…Ù† Ø£Ù† web-dir Ù‡Ùˆ www)
          npx cap init App com.ajwan.offline --web-dir www
          npx cap add android
          
          # Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: ğŸ“¦ Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Ajwan-Offline-Final
          path: /tmp/app_build/android/app/build/outputs/apk/debug/app-debug.apk
